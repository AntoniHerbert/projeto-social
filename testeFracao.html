<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operações com Frações</title>
    <style>
        .fraction {
            display: inline-block;
            text-align: center;
            margin: 10px;
            vertical-align: middle;
        }
        .numerator, .denominator {
            display: block;
            width: 100%;
        }
        .fraction-line {
            border-top: 1px solid black;
            margin: 0.1em 0;
        }
        .operation {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .operator {
            margin: 0 10px;
            font-size: 20px;
        }
        .intermediate {
            font-size: 14px;
            margin-top: 10px;
        }
        .container {
            border: 1px dashed gray;
            padding: 5px;
            margin: 5px;
            min-height: 40px;
        }
        .draggable {
            background-color: lightblue;
            border: 1px solid blue;
            padding: 5px;
            margin: 2px;
            cursor: move;
        }
    </style>
</head>
<body>
    <div id="output"></div>
    <script>
        // Classe Numero
        class Numero {
            constructor(valor, sinal) {
                this.valor = valor;
                this.sinal = sinal;
            }

            toString() {
                return `${this.sinal}${this.valor}`;
            }
        }

        // Classe Fracao
        class Fracao {
            constructor(numerador, denominador) {
                this.numerador = numerador;
                this.denominador = denominador;
            }

            toString() {
                return `${this.numerador}/${this.denominador}`;
            }

            render() {
                return `
                    <div class="fraction">
                        <div class="numerator">
                            <div class="container draggable" draggable="true" id="numerador-${this.numerador}">${this.numerador}</div>
                        </div>
                        <div class="fraction-line"></div>
                        <div class="denominator">
                            <div class="container draggable" draggable="true" id="denominador-${this.denominador}">${this.denominador}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Classe Operador
        class Operador {
            constructor(esquerda, direita, tipo) {
                this.esquerda = esquerda;
                this.direita = direita;
                this.tipo = tipo;
            }

            render() {
                return `<div class="operator container">${this.tipo}</div>`;
            }
        }

        // Função para gerar números aleatórios
        function gerarNumeroAleatorio() {
            const valor = Math.floor(Math.random() * 101);  // Valor de 0 a 100
            return new Numero(valor, '+');  // Sempre será positivo
        }

        // Função para gerar uma fração a partir de dois números
        function gerarFracao(numerador, denominador) {
            return new Fracao(numerador, denominador);
        }

        // Função para gerar um operador com tipos diferentes (+, -, *, /)
        function gerarOperador(fracao1, fracao2) {
            const operadores = ['+', '-', '*', '/'];
            const tipo = operadores[Math.floor(Math.random() * operadores.length)];
            return new Operador(fracao1, fracao2, tipo);
        }

        // Função para gerar uma operação
        function gerarOperacao() {
            const numeros = [];
            for (let i = 0; i < 4; i++) {
                numeros.push(gerarNumeroAleatorio());
            }

            const fracao1 = gerarFracao(numeros[0].valor, numeros[1].valor);
            const fracao2 = gerarFracao(numeros[2].valor, numeros[3].valor);
            const operador = gerarOperador(fracao1, fracao2);
            return [fracao1, operador, fracao2];
        }

        // Função para operar as frações e exibir o resultado no HTML
        async function operar(operacao) {
            const [fracao1, operador, fracao2] = operacao;
            const outputDiv = document.getElementById('output');
            
            // Renderizar a operação inicial (fracao1 operador fracao2)
            outputDiv.innerHTML += `
                <div class="operation">
                    ${fracao1.render()}
                    ${operador.render()}
                    ${fracao2.render()}
                </div>
            `;

            // Variáveis para armazenar resultados
            let numeradorResultado;
            let denominadorResultado;

            // Adiciona eventos de arrastar e soltar
            const containers = outputDiv.querySelectorAll('.container');
            containers.forEach(container => {
                container.addEventListener('dragstart', dragStart);
                container.addEventListener('dragover', dragOver);
                container.addEventListener('drop', drop);
            });

            function dragStart(event) {
                event.dataTransfer.setData('text/plain', event.target.id);
            }

            function dragOver(event) {
                event.preventDefault();
            }

            async function drop(event) {
                event.preventDefault();
                const draggedId = event.dataTransfer.getData('text/plain');
                const draggedElement = document.getElementById(draggedId);
                const targetElement = event.target;

                if (draggedElement && targetElement && targetElement.classList.contains('container')) {
                    // Verifica se o alvo é um numerador ou denominador correspondente
                    if (operador.tipo === '*' && targetElement.id.includes('numerador')) {
                        const resultado = prompt(`Qual é o resultado da multiplicação ${fracao1.numerador} * ${fracao2.numerador}?`);
                        if (resultado == fracao1.numerador * fracao2.numerador) {
                            numeradorResultado = resultado;
                            alert('Correto!');
                        } else {
                            alert('Tente novamente!');
                        }
                    } else if (operador.tipo === '*' && targetElement.id.includes('denominador')) {
                        const resultado = prompt(`Qual é o resultado da multiplicação ${fracao1.denominador} * ${fracao2.denominador}?`);
                        if (resultado == fracao1.denominador * fracao2.denominador) {
                            denominadorResultado = resultado;
                            alert('Correto!');
                            mostrarResultado(numeradorResultado, denominadorResultado, 'Resultado da multiplicação:');
                        } else {
                            alert('Tente novamente!');
                        }
                    } else if (operador.tipo === '/') {
                        // Lógica para divisão
                        if (targetElement.id.includes('denominador')) {
                            const resultadoMultiplicacao = prompt(`Qual é o resultado da multiplicação ${fracao1.numerador} * ${fracao2.denominador}?`);
                            const resultadoDenominador = prompt(`Qual é o resultado da multiplicação ${fracao2.numerador} * ${fracao1.denominador}?`);
                            if (resultadoMultiplicacao == fracao1.numerador * fracao2.denominador &&
                                resultadoDenominador == fracao2.numerador * fracao1.denominador) {
                                numeradorResultado = resultadoMultiplicacao;
                                denominadorResultado = resultadoDenominador; // Aplica a operação de divisão
                                alert('Correto!');
                                mostrarResultado(numeradorResultado, denominadorResultado, 'Resultado da divisão:');
                            } else {
                                alert('Tente novamente!');
                            }
                        }
                    } else if (operador.tipo === '+') {
                        // Lógica para soma
                        // Agora segue o fluxo correto
                        if (targetElement.id.includes('numerador') && draggedElement.id.includes('numerador')) {
                            const resultadoNumerador1 = prompt(`Qual é o resultado da multiplicação ${fracao1.numerador} * ${fracao2.denominador}?`);
                            if (resultadoNumerador1 == fracao1.numerador * fracao2.denominador) {
                                alert('Correto!');

                                // Espera o usuário arrastar o outro numerador para o denominador
                                const nextDropContainer = await esperarPorDrop(targetElement.id, 'denominador');
                                const resultadoNumerador2 = prompt(`Qual é o resultado da multiplicação ${fracao2.numerador} * ${fracao1.denominador}?`);
                                if (resultadoNumerador2 == fracao2.numerador * fracao1.denominador) {
                                    alert('Correto!');

                                    // Espera o usuário arrastar um denominador para o outro denominador
                                    await esperarPorDrop(nextDropContainer, 'denominador');
                                    const resultadoDenominador = prompt(`Qual é o resultado da multiplicação ${fracao1.denominador} * ${fracao2.denominador}?`);
                                    if (resultadoDenominador == fracao1.denominador * fracao2.denominador) {
                                        alert('Correto!');

                                        // Criar a fração intermediária com duas divs draggable
                                        const fracaoIntermediaria = new Fracao(`${resultadoNumerador1}+${resultadoNumerador2}`, resultadoDenominador);
                                        outputDiv.innerHTML += `
                                            <div class="intermediate">Fração intermediária: ${fracaoIntermediaria.toString()}</div>
                                        `;

                                        // Espera o usuário arrastar um elemento do numerador para o outro
                                        const finalNumeradorContainer = await esperarPorDrop(`numerador-${resultadoNumerador1}`, 'numerador');
                                        const resultadoFinal = prompt(`Qual é o resultado da soma ${resultadoNumerador1} + ${resultadoNumerador2}?`);
                                        if (resultadoFinal == (parseInt(resultadoNumerador1) + parseInt(resultadoNumerador2))) {
                                            alert('Correto!');
                                            // Mostrar a fração final
                                            outputDiv.innerHTML += `
                                                <div class="final">Fração final: ${parseInt(resultadoNumerador1) + parseInt(resultadoNumerador2)}/${resultadoDenominador}</div>
                                            `;
                                        } else {
                                            alert('Tente novamente!');
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Função para esperar pelo drop em um determinado container
            function esperarPorDrop(containerId, tipo) {
                return new Promise(resolve => {
                    const container = document.getElementById(containerId);
                    container.addEventListener('dragover', event => {
                        event.preventDefault();
                    });
                    container.addEventListener('drop', event => {
                        event.preventDefault();
                        resolve(containerId);  // Resolve com o ID do container
                    }, { once: true });  // Remove o evento após o primeiro drop
                });
            }

            function mostrarResultado(numerador, denominador, mensagem) {
                const outputDiv = document.getElementById('output');
                outputDiv.innerHTML += `
                    <div class="result">${mensagem} ${numerador}/${denominador}</div>
                `;
            }
        }

        // Executar a operação ao carregar a página
        const operacao = gerarOperacao();
        operar(operacao);
    </script>
</body>
</html>
